<div id="map" style="width: 100%; height: 300px; border: 1px solid #ccc; margin-bottom: 10px;"></div>

<script>
  const CACONDE_LAT = -21.5288;
  const CACONDE_LNG = -46.6438;
  
  // Função para limpar o mapa existente
  function cleanupMap() {
    if (window.simpleMap) {
      window.simpleMap.remove();
      window.simpleMap = null;
      window.simpleMarker = null;
    }
  }
  
  // Função para inicializar o mapa
  function initializeMap() {
    // Limpar mapa existente antes de criar um novo
    cleanupMap();
    
    // Verificar se o Leaflet está disponível
    if (typeof L === 'undefined') {
      console.error("Leaflet não está disponível!");
      return;
    }
    
    // Verificar se o elemento do mapa existe
    const mapElement = document.getElementById('map');
    if (!mapElement) {
      console.error("Elemento do mapa não encontrado!");
      return;
    }
    
    try {
      // Inicializar o mapa com as coordenadas de Caconde
      window.simpleMap = L.map('map').setView([CACONDE_LAT, CACONDE_LNG], 13);
      
      // Adicionar camada de tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(window.simpleMap);
      
      // Adicionar marcador inicial
      window.simpleMarker = L.marker([CACONDE_LAT, CACONDE_LNG], {
        draggable: true
      }).addTo(window.simpleMap);
      
      // Atualizar coordenadas quando o marcador for movido
      window.simpleMarker.on('dragend', function(e) {
        const latlng = window.simpleMarker.getLatLng();
        document.getElementById('complaint_latitude').value = latlng.lat;
        document.getElementById('complaint_longitude').value = latlng.lng;
        
        // Buscar endereço a partir das coordenadas (geocodificação reversa)
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}`)
          .then(response => response.json())
          .then(data => {
            if (data.display_name) {
              document.getElementById('address-input').value = data.display_name;
            }
          })
          .catch(error => console.error('Erro ao buscar endereço:', error));
      });
      
      // Definir coordenadas iniciais nos campos ocultos
      document.getElementById('complaint_latitude').value = CACONDE_LAT;
      document.getElementById('complaint_longitude').value = CACONDE_LNG;
      
      // Forçar a renderização do mapa
      window.simpleMap.invalidateSize();
    } catch (error) {
      console.error("Erro ao inicializar o mapa:", error);
    }
  }
  
  // Remover eventos anteriores e adicionar novos
  document.removeEventListener('turbo:render', initializeMap);
  document.removeEventListener('turbo:load', initializeMap);
  
  // Adicionar eventos do Turbo
  document.addEventListener('turbo:render', initializeMap);
  document.addEventListener('turbo:load', initializeMap);
  
  // Limpar mapa quando a página for desmontada
  document.addEventListener('turbo:before-render', cleanupMap);
</script>