<div id="home-map" style="width: 100%; height: 400px; border: 1px solid #ccc; margin-bottom: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);"></div>

<script>
  // Coordenadas de Caconde
  const CACONDE_LAT = -21.5288;
  const CACONDE_LNG = -46.6438;
  
  // Função para inicializar o mapa da home
  function initializeHomeMap() {
    console.log("Inicializando mapa da home...");
    
    // Verificar se o Leaflet está disponível
    if (typeof L === 'undefined') {
      console.error("Leaflet não está disponível!");
      return;
    }
    
    // Verificar se o elemento do mapa existe
    const mapElement = document.getElementById('home-map');
    if (!mapElement) {
      console.error("Elemento do mapa não encontrado!");
      return;
    }
    
    try {
      console.log("Criando mapa com coordenadas de Caconde:", CACONDE_LAT, CACONDE_LNG);
      
      // Inicializar o mapa com as coordenadas de Caconde
      window.homeMap = L.map('home-map').setView([CACONDE_LAT, CACONDE_LNG], 13);
      
      // Adicionar camada de tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(window.homeMap);
      
      // Adicionar marcadores para cada reclamação
      <% if @complaints.present? %>
        <% @complaints.each do |complaint| %>
          <% if complaint.latitude.present? && complaint.longitude.present? %>
            // Criar marcador
            const marker<%= complaint.id %> = L.marker([<%= complaint.latitude %>, <%= complaint.longitude %>]).addTo(window.homeMap);
            
            // Adicionar popup com informações da reclamação
            marker<%= complaint.id %>.bindPopup(`
              <div class="popup-content">
                <strong><%= complaint.title %></strong><br>
                <em>Categoria: <%= Complaint.categories[complaint.category] %></em><br>
                <em>Status: <%= Complaint.statuses[complaint.status] %></em><br>
                <p><%= truncate(complaint.description, length: 150) %></p>
                <a href="/complaints/<%= complaint.id %>" class="btn btn-sm btn-info">Ver detalhes</a>
              </div>
            `);
          <% end %>
        <% end %>
      <% else %>
        console.log("Nenhuma reclamação encontrada com coordenadas válidas.");
      <% end %>
      
      // Forçar a renderização do mapa
      setTimeout(() => {
        window.homeMap.invalidateSize();
        console.log("Mapa da home inicializado com sucesso!");
      }, 100);
    } catch (error) {
      console.error("Erro ao inicializar o mapa da home:", error);
    }
  }
  
  // Inicializar o mapa quando o documento estiver pronto
  document.addEventListener('DOMContentLoaded', function() {
    console.log("DOMContentLoaded - Inicializando mapa da home...");
    setTimeout(initializeHomeMap, 100);
  });
  
  // Inicializar o mapa quando a página for carregada via Turbo
  document.addEventListener('turbo:load', function() {
    console.log("turbo:load - Inicializando mapa da home...");
    setTimeout(initializeHomeMap, 100);
  });
  
  // Inicializar o mapa quando a página for renderizada via Turbo
  document.addEventListener('turbo:render', function() {
    console.log("turbo:render - Inicializando mapa da home...");
    setTimeout(initializeHomeMap, 100);
  });
  
  // Inicializar o mapa imediatamente
  console.log("Executando inicialização imediata do mapa da home...");
  setTimeout(initializeHomeMap, 100);
</script>
