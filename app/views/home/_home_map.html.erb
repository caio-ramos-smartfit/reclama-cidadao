<div id="home-map" style="width: 100%; height: 400px; border: 1px solid #ccc; margin-bottom: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);"></div>

<script>
  // Variável para controlar se os marcadores já foram adicionados
  let markersAdded = false;
  
  // Função para adicionar marcadores ao mapa
  function addMarkersToHomeMap() {
    console.log("[HomeMap] Adicionando marcadores ao mapa...");
    
    if (!window.homeMap) {
      console.error("[HomeMap] Mapa não inicializado!");
      return;
    }
    
    // Verificar se os marcadores já foram adicionados
    if (markersAdded) {
      console.log("[HomeMap] Marcadores já adicionados, ignorando...");
      return;
    }
    
    // Limpar marcadores existentes
    if (window.homeMapMarkers && window.homeMapMarkers.length > 0) {
      console.log("[HomeMap] Limpando marcadores existentes...");
      window.homeMapMarkers.forEach(marker => {
        window.homeMap.removeLayer(marker);
      });
    }
    
    // Inicializar array de marcadores
    window.homeMapMarkers = [];
    
    console.log("[HomeMap] Verificando reclamações para adicionar marcadores...");
    
    <% if @complaints.present? %>
      <% @complaints.each do |complaint| %>
        <% if complaint.latitude.present? && complaint.longitude.present? %>
          // Criar marcador
          const marker<%= complaint.id %> = L.marker([<%= complaint.latitude %>, <%= complaint.longitude %>]).addTo(window.homeMap);
          window.homeMapMarkers.push(marker<%= complaint.id %>);
          
          // Adicionar popup com informações da reclamação
          marker<%= complaint.id %>.bindPopup(`
            <div class="popup-content">
              <strong><%= complaint.title %></strong><br>
              <em>Categoria: <%= complaint.category_before_type_cast.is_a?(String) ? complaint.category : Complaint.categories[complaint.category] %></em><br>
              <em>Status: <%= complaint.status_before_type_cast.is_a?(String) ? complaint.status : Complaint.statuses[complaint.status] %></em><br>
              <p><%= truncate(complaint.description, length: 150) %></p>
              <a href="/complaints/<%= complaint.id %>" class="btn btn-sm btn-info">Ver detalhes</a>
            </div>
          `);
          
          console.log("[HomeMap] Marcador adicionado para reclamação #<%= complaint.id %> em [<%= complaint.latitude %>, <%= complaint.longitude %>]");
          
          // Disparar um evento personalizado para depuração (sem declarar variável)
          document.dispatchEvent(new CustomEvent('markerAdded', { detail: { id: <%= complaint.id %> } }));
        <% end %>
      <% end %>
      
      // Marcar que os marcadores foram adicionados
      markersAdded = true;
      console.log("[HomeMap] Total de marcadores adicionados: <%= @complaints.where.not(latitude: nil, longitude: nil).count %>");
    <% else %>
      console.log("[HomeMap] Nenhuma reclamação encontrada com coordenadas válidas.");
    <% end %>
  }
  
  // Adicionar marcadores quando o mapa for inicializado
  document.addEventListener('homeMapInitialized', function() {
    console.log("[HomeMap] Evento homeMapInitialized recebido, adicionando marcadores...");
    addMarkersToHomeMap();
  });
  
  // Também tentar adicionar marcadores nos eventos padrão (fallback)
  document.addEventListener('DOMContentLoaded', function() {
    console.log("[HomeMap] DOMContentLoaded - Verificando se o mapa está pronto...");
    setTimeout(function() {
      if (window.homeMap) {
        addMarkersToHomeMap();
      }
    }, 500);
  });
  
  // Também tentar adicionar marcadores quando a página for carregada via Turbo
  document.addEventListener('turbo:load', function() {
    console.log("[HomeMap] turbo:load - Verificando se o mapa está pronto...");
    setTimeout(function() {
      if (window.homeMap) {
        addMarkersToHomeMap();
      }
    }, 500);
  });
  
  // Adicionar um listener para o evento de reinicialização do mapa
  document.addEventListener('homeMapReset', function() {
    console.log("[HomeMap] Evento homeMapReset recebido, redefinindo estado dos marcadores...");
    markersAdded = false;
  });
  
  // Adicionar um listener para o evento de depuração
  document.addEventListener('markerAdded', function(event) {
    console.log("[HomeMap] Evento markerAdded recebido para reclamação #" + event.detail.id);
  });
</script>